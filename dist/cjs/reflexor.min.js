"use strict";var e;class t{static async openIndexedDB(e="ReflexorDB",t="reflexStates"){return new Promise(((i,s)=>{const n=indexedDB.open(e,1);n.onupgradeneeded=e=>{const i=e.target.result;i.objectStoreNames.contains(t)||i.createObjectStore(t,{keyPath:"key"})},n.onsuccess=e=>i(e.target.result),n.onerror=e=>s(e.target.error)}))}static async saveToIndexedDB(e,t,i="reflexStates"){return this.enqueueTransaction((async()=>{const s=await this.openIndexedDB();return new Promise(((n,r)=>{const a=s.transaction(i,"readwrite").objectStore(i).put({key:e,value:t});a.onsuccess=()=>n(),a.onerror=e=>r(e.target.error)}))}))}static async getFromIndexedDB(e,t="reflexStates"){const i=await this.openIndexedDB();return new Promise(((s,n)=>{const r=i.transaction(t,"readonly").objectStore(t).get(e);r.onsuccess=e=>{var t;return s((null===(t=e.target.result)||void 0===t?void 0:t.value)||null)},r.onerror=e=>n(e.target.error)}))}static ensureFileExists(){var e;this.isNode&&!(null===(e=this.fs)||void 0===e?void 0:e.existsSync(this.FILE_PATH))&&this.fs.writeFileSync(this.FILE_PATH,JSON.stringify({}))}static saveToFile(e,t){if(!this.isNode)return;this.ensureFileExists();const i=JSON.parse(this.fs.readFileSync(this.FILE_PATH,"utf-8"));i[e]=t,this.fs.writeFileSync(this.FILE_PATH,JSON.stringify(i,null,2))}static getFromFile(e){if(!this.isNode)return null;this.ensureFileExists();return JSON.parse(this.fs.readFileSync(this.FILE_PATH,"utf-8"))[e]||null}static async saveState(e,t){this.isNode?this.saveToFile(e,t):await this.saveToIndexedDB(e,t)}static async getState(e){return this.isNode?this.getFromFile(e):await this.getFromIndexedDB(e)}static async initialize(){if(this.initialized)return;const e=[];return this.reflexStates.forEach((t=>{t.persisted&&t.key&&e.push(this.getState(t.key).then((e=>{null!==e&&(t.value=e)})))})),this.initializationPromise=Promise.all(e).then((()=>{this.initialized=!0})),this.initializationPromise}static enableBatching(){this.batchingEnabled=!0}static disableBatching(){this.batchingEnabled=!1}static flushBatches(){this.batchingEnabled=!1,this.batchedUpdates.forEach(((e,t)=>{const i=this.reflexStates.get(t);i&&(i.value=e,i.listeners.forEach((t=>t(e))))})),this.batchedUpdates.clear()}static setValueWithBatching(e,t){this.batchingEnabled?this.batchedUpdates.set(e.key,t):(e.value=t,e.listeners.forEach((e=>e(t))))}static enqueueTransaction(e){return this.transactionQueue=this.transactionQueue.then(e),this.transactionQueue}static setLogger(e){this.logger=e}static log(e,...t){this.logger&&"function"==typeof this.logger[e]&&this.logger[e](...t)}static reflex(e,t){const i=Boolean(t&&t.length>0),s=i?(e=>{function t(e,t){return e<<t|e>>>32-t}function i(e,t){const i=1073741824&e,s=1073741824&t,n=2147483648&e,r=2147483648&t,a=(1073741823&e)+(1073741823&t);return i&s?2147483648^a^n^r:i|s?1073741824&a?3221225472^a^n^r:1073741824^a^n^r:a^n^r}function s(e,s,n,r,a,o,l){return e=i(e,i(i(function(e,t,i){return e&t|~e&i}(s,n,r),a),l)),i(t(e,o),s)}function n(e,s,n,r,a,o,l){return e=i(e,i(i(function(e,t,i){return e&i|t&~i}(s,n,r),a),l)),i(t(e,o),s)}function r(e,s,n,r,a,o,l){return e=i(e,i(i(function(e,t,i){return e^t^i}(s,n,r),a),l)),i(t(e,o),s)}function a(e,s,n,r,a,o,l){return e=i(e,i(i(function(e,t,i){return t^(e|~i)}(s,n,r),a),l)),i(t(e,o),s)}function o(e){let t="";for(let i=0;i<=3;i++)t+=("0"+(e>>>8*i&255).toString(16)).slice(-2);return t}let l,c,u,h,d,f,g,p,v,S=[];for(e=function(e){e=e.replace(/\r\n/g,"\n");let t="";for(let i=0;i<e.length;i++){const s=e.charCodeAt(i);s<128?t+=String.fromCharCode(s):s>127&&s<2048?(t+=String.fromCharCode(s>>6|192),t+=String.fromCharCode(63&s|128)):(t+=String.fromCharCode(s>>12|224),t+=String.fromCharCode(s>>6&63|128),t+=String.fromCharCode(63&s|128))}return t}(e),S=function(e){const t=e.length,i=t+8,s=16*((i-i%64)/64+1),n=new Array(s-1);let r=0,a=0;for(;a<t;){const t=(a-a%4)/4;r=a%4*8,n[t]=n[t]|e.charCodeAt(a)<<r,a++}const o=(a-a%4)/4;return r=a%4*8,n[o]=n[o]|128<<r,n[s-2]=t<<3,n[s-1]=t>>>29,n}(e),f=1732584193,g=4023233417,p=2562383102,v=271733878,l=0;l<S.length;l+=16)c=f,u=g,h=p,d=v,f=s(f,g,p,v,S[l+0],7,3614090360),v=s(v,f,g,p,S[l+1],12,3905402710),p=s(p,v,f,g,S[l+2],17,606105819),g=s(g,p,v,f,S[l+3],22,3250441966),f=s(f,g,p,v,S[l+4],7,4118548399),v=s(v,f,g,p,S[l+5],12,1200080426),p=s(p,v,f,g,S[l+6],17,2821735955),g=s(g,p,v,f,S[l+7],22,4249261313),f=s(f,g,p,v,S[l+8],7,1770035416),v=s(v,f,g,p,S[l+9],12,2336552879),p=s(p,v,f,g,S[l+10],17,4294925233),g=s(g,p,v,f,S[l+11],22,2304563134),f=s(f,g,p,v,S[l+12],7,1804603682),v=s(v,f,g,p,S[l+13],12,4254626195),p=s(p,v,f,g,S[l+14],17,2792965006),g=s(g,p,v,f,S[l+15],22,1236535329),f=n(f,g,p,v,S[l+1],5,4129170786),v=n(v,f,g,p,S[l+6],9,3225465664),p=n(p,v,f,g,S[l+11],14,643717713),g=n(g,p,v,f,S[l+0],20,3921069994),f=n(f,g,p,v,S[l+5],5,3593408605),v=n(v,f,g,p,S[l+10],9,38016083),p=n(p,v,f,g,S[l+15],14,3634488961),g=n(g,p,v,f,S[l+4],20,3889429448),f=n(f,g,p,v,S[l+9],5,568446438),v=n(v,f,g,p,S[l+14],9,3275163606),p=n(p,v,f,g,S[l+3],14,4107603335),g=n(g,p,v,f,S[l+8],20,1163531501),f=n(f,g,p,v,S[l+13],5,2850285829),v=n(v,f,g,p,S[l+2],9,4243563512),p=n(p,v,f,g,S[l+7],14,1735328473),g=n(g,p,v,f,S[l+12],20,2368359562),f=r(f,g,p,v,S[l+5],4,4294588738),v=r(v,f,g,p,S[l+8],11,2272392833),p=r(p,v,f,g,S[l+11],16,1839030562),g=r(g,p,v,f,S[l+14],23,4259657740),f=r(f,g,p,v,S[l+1],4,2763975236),v=r(v,f,g,p,S[l+4],11,1272893353),p=r(p,v,f,g,S[l+7],16,4139469664),g=r(g,p,v,f,S[l+10],23,3200236656),f=r(f,g,p,v,S[l+13],4,681279174),v=r(v,f,g,p,S[l+0],11,3936430074),p=r(p,v,f,g,S[l+3],16,3572445317),g=r(g,p,v,f,S[l+6],23,76029189),f=r(f,g,p,v,S[l+9],4,3654602809),v=r(v,f,g,p,S[l+12],11,3873151461),p=r(p,v,f,g,S[l+15],16,530742520),g=r(g,p,v,f,S[l+2],23,3299628645),f=a(f,g,p,v,S[l+0],6,4096336452),v=a(v,f,g,p,S[l+7],10,1126891415),p=a(p,v,f,g,S[l+14],15,2878612391),g=a(g,p,v,f,S[l+5],21,4237533241),f=a(f,g,p,v,S[l+12],6,1700485571),v=a(v,f,g,p,S[l+3],10,2399980690),p=a(p,v,f,g,S[l+10],15,4293915773),g=a(g,p,v,f,S[l+1],21,2240044497),f=a(f,g,p,v,S[l+8],6,1873313359),v=a(v,f,g,p,S[l+15],10,4264355552),p=a(p,v,f,g,S[l+6],15,2734768916),g=a(g,p,v,f,S[l+13],21,1309151649),f=a(f,g,p,v,S[l+4],6,4149444226),v=a(v,f,g,p,S[l+11],10,3174756917),p=a(p,v,f,g,S[l+2],15,718787259),g=a(g,p,v,f,S[l+9],21,3951481745),f=i(f,c),g=i(g,u),p=i(p,h),v=i(v,d);return(o(f)+o(g)+o(p)+o(v)).toLowerCase()})(`reflex-${t}`):void 0;let n=e;s&&this.getState(s).then((e=>{null!==e&&(r.value=e,r.listeners.forEach((t=>t(e))))})).catch((e=>{console.error("Error retrieving persisted value:",e)}));const r={value:n,initialValue:e,listeners:[],dropListeners:[],resetListeners:[],persisted:i,key:s},a=async()=>{r.persisted&&r.key&&await this.saveState(r.key,r.value)},o=new Proxy(r,{set:(e,t,i)=>"value"===t&&(e.value=i,e.listeners.forEach((e=>e(i))),a(),!0),deleteProperty:(e,t)=>"value"===t&&(e.dropListeners.forEach((t=>t(e.value))),delete e.value,r.persisted&&r.key&&this.saveState(r.key,null),!0)});return this.reflexStates.set(o,r),o}static getReflexValue(e){const t=this.reflexStates.get(e);return t?t.value:void 0}static hasReflex(e){return this.reflexStates.has(e)}static removeReflex(e){const t=this.reflexStates.get(e);t&&t.key&&this.saveState(t.key,null),this.reflexStates.delete(e)}static getAllReflexes(){return this.reflexStates}static clearAllReflexes(){this.reflexStates.forEach(((e,t)=>{e.persisted&&e.key&&this.saveState(e.key,null)})),this.reflexStates.clear()}static getStateCount(){return this.reflexStates.size}static addMiddleware(e){this.middlewares.push(e)}static applyMiddlewares(e,t){return this.middlewares.reduce(((t,i)=>i(e,t)),t)}static setValueWithMiddleware(e,t){const i=this.applyMiddlewares(e,t);e.value=i,e.listeners.forEach((e=>e(i)))}static onReflexChange(e,t){t.forEach((t=>{const i=this.reflexStates.get(t);i&&i.listeners.push(e)}))}static onReflexDrop(e,t){t.forEach((t=>{const i=this.reflexStates.get(t);i&&i.dropListeners.push(e)}))}static onReflexReset(e,t){t.forEach((t=>{const i=this.reflexStates.get(t);i&&i.resetListeners.push(e)}))}static reset(e){const t=this.reflexStates.get(e);t&&(t.value=t.initialValue,t.persisted&&t.key&&this.saveState(t.key,t.initialValue),t.listeners.forEach((e=>e(t.initialValue))),t.resetListeners.forEach((e=>e(t.initialValue))))}}e=t,t.reflexStates=new Map,t.isNode="undefined"==typeof window,t.initialized=!1,t.initializationPromise=null,t.batchingEnabled=!1,t.batchedUpdates=new Map,t.transactionQueue=Promise.resolve(),t.logger=console,t.middlewares=[],t.fs=e.isNode?require("fs"):null,t.path=e.isNode?require("path"):null,t.FILE_PATH=e.isNode?e.path.resolve(__dirname,"reflexor_store.json"):null,e.initialize().catch((e=>{console.error("Failed to initialize Reflexor:",e)}));const i="undefined"==typeof window,s=Object.assign({Reflexor:t},i?{}:{ReflexorRenderer:new class{constructor(){if(this.updateQueue=new Map,this.batchId=null,this.virtualizedComponents=[],this.observer=null,"undefined"==typeof window||!window.document)throw new Error("ReflexorRenderer requires a DOM environment.");this.bindings=new Map}bind(e,i,s){if(!e||!i)throw new Error("Invalid element or state for binding.");(null==s?void 0:s.className)&&e.classList.add(s.className),(null==s?void 0:s.attributes)&&Object.entries(s.attributes).forEach((([t,i])=>{e.setAttribute(t,i)})),this.batchUpdateElement(e,i.value),t.onReflexChange((t=>{this.batchUpdateElement(e,t)}),[i]),this.bindings.set(e,i)}bindWithjQuery(e,t){const i=e[0];this.bind(i,t)}unbind(e){const i=this.bindings.get(e);i&&(t.removeReflex(i),this.bindings.delete(e))}batchUpdateElement(e,t){this.updateQueue.set(e,t),null===this.batchId&&(this.batchId=requestAnimationFrame((()=>{this.updateQueue.forEach(((e,t)=>{this.updateElement(t,e)})),this.updateQueue.clear(),this.batchId=null})))}updateElement(e,t){if(e)if(e instanceof HTMLInputElement||e instanceof HTMLTextAreaElement)e.value=t;else if(e instanceof HTMLSelectElement){Array.from(e.options).find((e=>e.value===t.toString()))?e.value=t.toString():console.warn(`Value "${t}" not found in select options.`)}else e instanceof HTMLImageElement?e.src=t.toString():e instanceof HTMLAnchorElement?(e.href=t.toString(),e.textContent=t.toString()):e instanceof HTMLProgressElement||e instanceof HTMLMeterElement?e.value=parseFloat(t):(HTMLButtonElement,e.textContent=t.toString());else console.warn("Element is null or undefined. Skipping update.")}render(e,i,s){e.innerHTML=i(),t.onReflexChange((()=>{const t=i();e.innerHTML!==t&&(e.innerHTML=t)}),s)}initializeVirtualization(e){this.observer=new IntersectionObserver((e=>{e.forEach((e=>{if(e.isIntersecting){e.target.style.visibility="visible"}else{e.target.style.visibility="hidden"}}))}),{root:e,threshold:.1})}addToVirtualDOM(e){this.virtualizedComponents.push(e),this.observer.observe(e)}}});module.exports=s;
//# sourceMappingURL=reflexor.min.js.map
